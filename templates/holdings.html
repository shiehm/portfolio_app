{% extends 'layout.html' %}

{% block content %}
<header>
    {% if account_id == None %}
        <h1>Portfolio Overview: All Holdings</h1>
    {% else %}
        {% for account in accounts %}
            {% if account['id'] == account_id %}
                <h1>Portfolio Overview: {{ account['account_name'] }} ({{ account['account_type'] }})</h1>
            {% endif %}
        {% endfor %}
    {% endif %}
</header>

<div class="table-wrap">
    <table class="holdings">
        <thead>
            <tr>
                {% for column in columns if 'id' not in column %}
                    <th>{{ column | replace('_', ' ') | title }}</th>
                {% endfor %}
            </tr>
            <tr>
                {% for column in columns if 'id' not in column %}
                    {% if column == 'account_name' %}
                        <th>
                            <form method="get" action="{{ url_for('get_holdings') }}">
                                <select id="account_id" name="account_id" onchange="this.form.submit()">
                                    <option value="" {% if account_id is none %}selected{% endif %}>All</option>
                                    {% for account in accounts %}
                                    <option value="{{ account['id'] }}" {% if account_id == account['id'] %}selected{% endif %}>
                                        {{ account['account_name'] }} ({{ account['account_type'] }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <noscript>
                                    <button type="submit">Apply</button>
                                </noscript>
                            </form>    
                        </th>
                    {% else %}
                        <th></th>
                    {% endif %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for dic in lists %}
            <tr>
                {% for key, value in dic.items() if 'id' not in key %}
                    {% if key in ('current_price', 'market_value') %}
                        <td class="currency">${{ "{:,.2f}".format(value | float) }}</td>
                    {% elif key == 'shares' %}
                        <td class="number">{{ "{:,}".format(value | int) }}</td>
                    {% elif 'percent' in key %}
                        <td class="percent">{{ '{:.2%}'.format(value|float) }}</td>
                    {% else %}
                        <td>{{ value }}</td>
                    {% endif %} 
                {% endfor %}
                <td>
                    <form class="btn-row" action="{{ url_for('update_holding') }}">
                        <input type="hidden" name="holding_id" value="{{ dic['holding_id'] }}">
                        <button type="submit" class="update">Update</button>
                    </form>
                </td>
                <td>
                    {% if dic['holding_id'] %}
                        <form class="btn-row" method="post" action="{{ url_for('delete_holding') }}"
                        onsubmit="return confirm('Are you sure you want to delete this holding?');">
                            <input type="hidden" name="holding_id" value="{{ dic['holding_id'] }}">
                            <button type="submit" class="delete">Delete</button>
                        </form>
                    {% elif dic['asset_id'] %}
                        <form class="btn-row" method="post" action="{{ url_for('delete_asset') }}"
                        onsubmit="return confirm('Are you sure you want to delete this asset?');">
                            <input type="hidden" name="asset_id" value="{{ dic['asset_id'] }}">
                            <button type="submit" class="delete">Delete</button>
                        </form>
                    {% elif dic['account_id'] %}
                        <form class="btn-row" method="post" action="{{ url_for('delete_account') }}"
                        onsubmit="return confirm('Are you sure you want to delete this account?');">
                            <input type="hidden" name="account_id" value="{{ dic['account_id'] }}">
                            <button type="submit" class="delete">Delete</button>
                        </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
        {% set total_market_value = lists | map(attribute='market_value') | map('default', 0, true) | sum(start=0) %}
        {% set total_percent = lists | map(attribute='percent') | map('default', 0, true) | sum(start=0) %}
        <tfoot>
            <tr class="total-row">
                <td colspan="7"><strong>Total</strong></td>
                <td class="currency"><strong>${{ "{:,.2f}".format(total_market_value | float) }}</strong></td>
                <td class="percent"><strong>{{ "{:.2%}".format(total_percent | float) }}</strong></td>
            </tr>
        </tfoot>
    </table>
</div>
{% endblock %}

{% block links %}
<div class="actions">
  <a class="btn-add" href="{{ url_for('add_account') }}">Add Account</a>
  <a class="btn-add" href="{{ url_for('add_asset') }}">Add Asset</a>
  <a class="btn-add" href="{{ url_for('add_holding') }}">Add Holding</a>
</div>
{% endblock %}